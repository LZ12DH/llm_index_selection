select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '28391','64239','20347','73784','73824','66065',
                          '73199','59089','53201','62243','92719',
                          '37071','59574','76633','26382','16656',
                          '61917','89334','50969','67344','27359',
                          '83432','43653','94525','74307','54303',
                          '20010','43509','52976','82322','24982',
                          '86027','36604','49342','21047','48507',
                          '66415','44851','81425','96808','25230',
                          '88126','55068','70480','95932','60876',
                          '69464','38767','63796','93319','11001',
                          '10890','13117','43752','90688','71748',
                          '26144','14812','36603','54108','94671',
                          '58818','61476','21867','61594','69194',
                          '14575','86757','76286','32981','23473',
                          '28768','70489','66929','22539','73390',
                          '39172','63810','84886','29051','57545',
                          '76769','13506','36726','79223','32191',
                          '74497','27322','55997','30458','54297',
                          '48666','77502','48282','64066','85963',
                          '96708','60107','27853','48171','60037',
                          '94144','27514','46529','30300','33748',
                          '43518','78800','97745','42120','47639',
                          '65771','52068','66731','27664','31745',
                          '91226','90377','14603','28033','30431',
                          '81536','34988','96243','42655','32338',
                          '69267','36723','28623','77444','47421',
                          '31067','35719','74015','57576','17226',
                          '66114','82730','50769','32319','79672',
                          '74534','80801','77250','72566','94602',
                          '16602','79723','95952','88457','85468',
                          '59861','65350','40019','93908','49596',
                          '85681','10731','49038','75055','88540',
                          '38845','70411','96820','37220','83909',
                          '39161','27769','88296','58220','65589',
                          '34209','70043','81549','13269','61113',
                          '59388','98279','15351','40786','35295',
                          '22933','46141','36326','53159','40058',
                          '31209','17456','39039','41507','26092',
                          '44470','72116','11922','91613','30485',
                          '90668','69852','73591','84717','63784',
                          '73638','12531','53729','93058','43391',
                          '89166','10516','45662','33712','63634',
                          '86309','47151','49611','66150','80492',
                          '98855','75249','23696','99487','21585',
                          '61381','61627','17042','32937','31252',
                          '14468','82716','61701','46108','47587',
                          '59954','60474','88331','82466','21238',
                          '66206','70918','38467','25223','44439',
                          '65077','64998','87617','82051','93609',
                          '20011','19168','64594','91448','94908',
                          '83839','85393','99848','81733','22731',
                          '98696','33314','14763','59948','69441',
                          '93052','25756','62090','68535','60501',
                          '74992','52991','36767','63829','72579',
                          '47864','78028','11064','68261','97177',
                          '90090','69375','61205','45051','13452',
                          '72170','56238','12342','14144','71008',
                          '85506','55346','30657','34350','10107',
                          '52939','60779','66210','75463','95371',
                          '92558','63450','36826','39942','33840',
                          '59092','47329','36963','87721','82931',
                          '12512','22763','57808','84000','41473',
                          '37542','82097','57069','10455','16818',
                          '42867','32795','28351','26882','57138',
                          '53130','54989','18773','82718','75038',
                          '92886','55262','86886','37984','34962',
                          '61560','64223','69667','18294','32597',
                          '13655','86763','99226','37239','43778',
                          '70157','47076','42238','60312','45790',
                          '37213','84811','28060','43466','92636',
                          '40444','95018','76006','98667','26288',
                          '10292','58986','98566','21203','81895',
                          '40863','32224','61462','44450','33444',
                          '59155','11030','46922','14725','44646',
                          '13306','47003','10564','56713','20258',
                          '16536','85967','66781','67691','16491',
                          '10077','70688','82357','72506','47511',
                          '65645','73994','68609','74102','84599',
                          '27634','35818','52559','55580','39401',
                          '23121','73037','20480','27230')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 5 in stream 2 using template query8.tpl
