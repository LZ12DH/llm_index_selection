
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '90275','52739','69702','19033','55652','57150',
                          '34527','78157','72985','79944','40971',
                          '95142','55486','39001','35951','94348',
                          '32657','39768','91332','11757','50885',
                          '50052','88983','30485','19032','19836',
                          '59509','25621','86111','86116','27950',
                          '31979','84693','80093','38792','57151',
                          '77296','39826','56370','92956','83483',
                          '35135','49492','99420','62752','74701',
                          '43697','98832','79177','53446','10934',
                          '99308','55978','11375','59352','45075',
                          '48995','55759','30020','85611','87691',
                          '75616','78776','48021','18361','97075',
                          '44767','35895','36272','37181','90844',
                          '63251','45468','92652','83733','73156',
                          '97685','62516','63996','17286','45126',
                          '38797','99704','65148','97610','68428',
                          '21429','95967','28340','30792','56241',
                          '95116','14380','73974','86063','63111',
                          '30860','17686','72452','19241','95191',
                          '95146','92669','34387','14647','22638',
                          '66611','15588','16663','50544','17895',
                          '99736','19381','60286','63419','44844',
                          '36081','18470','54778','62973','45594',
                          '82458','29329','21191','36451','86548',
                          '98953','45969','16983','11195','90478',
                          '94234','65787','74745','47027','48427',
                          '17272','61255','20725','17157','37253',
                          '68602','65205','64614','74027','78848',
                          '87042','46380','94182','64607','69699',
                          '14845','26086','53093','77746','84493',
                          '57478','99748','12972','48421','40681',
                          '23218','68025','81056','39088','70245',
                          '52068','75694','26960','97276','35105',
                          '70637','50045','57167','51574','67602',
                          '21703','36558','94730','70929','96378',
                          '47254','19510','28303','57970','12115',
                          '94048','31480','82653','36922','14924',
                          '20830','74425','52085','75913','34139',
                          '17376','12335','53512','84600','27492',
                          '51305','86099','51949','76903','36427',
                          '48651','23086','26419','81583','23896',
                          '62393','26908','38624','11047','92849',
                          '94962','25354','28215','86312','35059',
                          '26203','30878','66424','14185','96006',
                          '36545','16324','61704','98992','87448',
                          '18331','35038','26739','80219','56916',
                          '57314','58746','61377','34472','25433',
                          '28509','14426','13054','89164','98069',
                          '49372','85770','62294','13943','96760',
                          '58621','54902','77515','27314','38261',
                          '58887','64225','70960','49497','59415',
                          '26461','99669','49926','29937','50563',
                          '85372','54954','71965','27641','25610',
                          '74702','66337','70680','50200','26785',
                          '55140','43334','94892','83433','31824',
                          '81720','12547','18396','31877','72393',
                          '54463','36305','40783','39325','75375',
                          '19683','89249','42166','24732','87011',
                          '36525','93896','46212','84377','38375',
                          '64990','10489','63531','23740','64435',
                          '18778','20737','14459','66237','80186',
                          '87586','73593','16349','13076','94933',
                          '78313','63323','76719','22184','82374',
                          '55072','54620','96300','21514','77277',
                          '86087','12090','15684','65278','34207',
                          '45901','11594','38260','50183','52555',
                          '26734','97313','16517','38137','77373',
                          '63319','43816','59470','79389','86978',
                          '65967','84431','51267','54095','32871',
                          '32732','98756','11332','31242','72417',
                          '11406','30079','49477','24571','97130',
                          '21709','59487','25767','93644','40829',
                          '14472','69911','18933','91842','81803',
                          '54271','85790','52597','70402','77353',
                          '50547','30325','58502','58515','66280',
                          '67258','69311','49291','89223','19776',
                          '25918','54444','75487','61830','31548',
                          '78643','18995','53099','71539','22857',
                          '34706','58314','97292','76258')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 8 in stream 0 using template query8