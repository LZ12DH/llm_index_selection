
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '88875','19716','98065','79886','85282','30998',
                          '95107','21412','20797','89345','12231',
                          '69747','87004','47301','13501','92077',
                          '86443','39278','67578','21651','53765',
                          '21429','40369','17425','40115','91419',
                          '49093','79931','30537','44633','37253',
                          '12085','80259','80682','41865','92354',
                          '84373','91190','60969','99911','26844',
                          '61259','49724','50397','89393','14056',
                          '12445','20338','68171','87716','87426',
                          '25157','84827','73599','81114','34315',
                          '73911','30988','18251','39108','29345',
                          '64430','95152','96089','22120','58265',
                          '79575','31215','48934','85723','53193',
                          '21428','59293','13685','51543','63486',
                          '49247','69239','79954','32791','71105',
                          '83458','16239','51746','62986','76281',
                          '19888','33862','31138','55442','89227',
                          '93022','97499','36776','46760','62425',
                          '93055','83885','32210','76920','32303',
                          '12259','61778','12686','90480','10060',
                          '29907','21143','39946','95648','17959',
                          '79833','97619','59570','58967','86975',
                          '52279','62901','26201','87150','63176',
                          '40756','90228','70026','81247','50275',
                          '71348','88382','64767','74587','37417',
                          '33928','74083','32914','45840','52455',
                          '49564','97758','62038','44484','35767',
                          '90053','54344','62226','89662','35777',
                          '71537','74347','16227','64817','82832',
                          '57604','71878','40460','66209','41378',
                          '67913','11973','30211','43949','89447',
                          '80476','80269','93917','22738','81833',
                          '79423','38892','16288','40124','28417',
                          '48551','83213','53607','58329','62908',
                          '78050','94048','25847','16289','40159',
                          '26939','95505','63511','39271','63574',
                          '60077','37853','75427','16251','12290',
                          '53749','34265','24140','74764','49573',
                          '22371','16519','55263','56521','40526',
                          '71408','88115','98967','82201','45614',
                          '38090','84305','49753','90720','49154',
                          '65923','44260','52195','33460','89073',
                          '33330','96946','25840','81341','19547',
                          '12210','24700','72437','61887','24258',
                          '92778','64181','79813','15944','63627',
                          '76853','48480','26044','62074','17330',
                          '31367','69816','88136','78653','83649',
                          '64489','39306','31107','68376','60034',
                          '72984','58938','41050','20022','88264',
                          '39553','13495','52373','75771','19692',
                          '43966','46412','62538','36461','88548',
                          '13105','18604','80505','20050','20046',
                          '81598','79828','90657','67671','41166',
                          '69273','52719','31018','90769','52581',
                          '92418','90181','35805','55681','90120',
                          '24866','82327','91131','57174','73001',
                          '92971','68807','56263','29512','37635',
                          '43403','73274','35197','98272','92690',
                          '92655','14537','32124','12060','49984',
                          '28687','21841','51063','87180','66568',
                          '51313','42297','71390','69427','11977',
                          '72436','35106','36136','65998','31151',
                          '78294','47778','18022','85195','34674',
                          '76724','38381','64223','83764','65302',
                          '71376','32193','88553','42332','71245',
                          '26315','68818','73118','67062','85471',
                          '99532','91721','67996','14263','13700',
                          '26093','70798','51845','26006','74538',
                          '66044','48851','21682','19949','32869',
                          '53210','78011','91080','66490','79162',
                          '14290','27985','97242','76861','75266',
                          '22241','44722','96011','86296','80875',
                          '67147','70667','92928','74384','17980',
                          '97001','99128','36215','27863','24855',
                          '21560','80213','44427','68869','86536',
                          '51222','75831','36839','75759','79845',
                          '83136','53216','22882','41159','34289',
                          '47769','27432','89253','74295','45661',
                          '79204','36934','34252','83314')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 8 in stream 0 using template query8