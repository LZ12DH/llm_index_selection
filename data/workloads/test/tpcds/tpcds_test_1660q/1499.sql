
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '55859','64871','47134','82759','60327','76968',
                          '37007','55348','90815','84079','36850',
                          '67985','87188','55153','16284','80363',
                          '95406','75295','79890','93431','57590',
                          '56157','66865','86291','58265','87585',
                          '31160','66500','76538','21115','18058',
                          '97525','45359','30779','12962','49067',
                          '85478','36129','34039','97665','67297',
                          '76006','72827','69076','29320','65246',
                          '94239','92781','74086','58165','18481',
                          '78099','36175','71188','12321','16183',
                          '12668','96140','20731','96566','88177',
                          '60169','50093','23492','40507','84569',
                          '30231','79598','40807','45743','10930',
                          '56940','28348','46311','46480','74927',
                          '77380','40275','89629','60534','75957',
                          '82509','72597','77159','67509','32429',
                          '73952','30513','91763','12067','63474',
                          '24813','47585','50978','29660','84185',
                          '77695','16834','79563','21312','22460',
                          '56607','19868','57453','90374','82990',
                          '91777','74614','25921','62545','61873',
                          '20357','96209','30005','78264','55268',
                          '78479','30374','95241','79839','24715',
                          '84462','30029','69022','61127','99921',
                          '41766','32945','43135','47383','54771',
                          '66074','54289','67802','71101','54001',
                          '78856','36955','89178','32767','33839',
                          '99938','10938','40238','57561','96694',
                          '80198','59299','15321','94167','18777',
                          '88978','32572','14499','74038','92245',
                          '18521','51650','69149','96016','40241',
                          '19409','59297','14904','32799','98327',
                          '40815','69157','82333','90756','75684',
                          '84568','15581','89237','72536','76311',
                          '13084','95386','49233','13737','59714',
                          '98907','96318','64900','42190','76466',
                          '79986','10675','25372','56182','72903',
                          '33798','53623','47990','82502','90263',
                          '89899','62542','53756','99552','48443',
                          '34712','20693','25123','95669','72167',
                          '37659','64141','36257','97708','85061',
                          '20627','28050','88411','21718','16892',
                          '89043','22936','55873','48792','99185',
                          '21729','25395','99049','83565','28143',
                          '74300','17183','96398','28293','20327',
                          '92324','79548','92021','58065','70755',
                          '61126','61376','50273','91466','81538',
                          '50637','14636','17732','63417','12285',
                          '10427','90832','65695','15056','91284',
                          '86309','23306','72071','70372','17844',
                          '51751','52782','93629','98627','98953',
                          '99350','10202','40123','85819','81991',
                          '69503','96676','65513','46469','59781',
                          '81652','30637','38067','52004','55438',
                          '66393','13101','52521','47087','46055',
                          '82341','52015','22028','80011','55080',
                          '71311','99640','52498','84022','51907',
                          '49453','36688','51189','85711','58434',
                          '18482','19490','27031','76961','38589',
                          '56533','16051','66584','81819','72970',
                          '73118','58381','80874','58801','86131',
                          '23080','38629','49361','70845','26490',
                          '62867','66181','35544','91886','55173',
                          '80398','21351','13637','79260','12075',
                          '24733','82618','98328','38128','73243',
                          '63707','47452','83773','25105','22981',
                          '30907','35461','46664','10080','75800',
                          '74696','75596','49748','74447','53714',
                          '50966','55529','39167','54119','54003',
                          '78561','89935','76760','19936','55548',
                          '57149','91641','46224','61108','40282',
                          '41376','65075','19766','41275','87835',
                          '27235','30296','64903','68810','58528',
                          '85694','16295','80217','49370','28382',
                          '76884','47784','28139','69718','61886',
                          '36651','76506','21706','86641','34250',
                          '36427','16710','30914','24450','84865',
                          '82139','55287','57194','14438','48051',
                          '10866','47783','65383','69145')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 8 in stream 0 using template query8