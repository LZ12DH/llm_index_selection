
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '34053','69558','77087','82814','30489','27565',
                          '72396','36182','19735','14511','84898',
                          '39658','89280','16198','14890','68358',
                          '80702','31242','84635','19837','80447',
                          '94723','34817','84598','81007','87547',
                          '25481','38535','41814','39826','77396',
                          '27696','13971','24391','76146','69802',
                          '62959','92316','23012','72910','90205',
                          '25268','65518','50677','77552','59897',
                          '68512','45786','69922','80043','69541',
                          '66796','89835','33808','39371','14808',
                          '41629','76538','89895','51477','76122',
                          '88205','44213','36950','52054','91264',
                          '43384','73935','23492','47650','95218',
                          '22302','32673','42416','79760','93540',
                          '93606','14985','62457','33737','20749',
                          '78939','57561','37101','14889','93906',
                          '90300','51814','58757','55766','94593',
                          '94761','83492','77084','96046','64125',
                          '96782','38344','82998','44476','81944',
                          '49672','85852','32061','25748','18466',
                          '40601','97317','84909','84831','83544',
                          '70155','71809','35370','94569','73335',
                          '56605','77189','71431','40329','33111',
                          '60329','83084','61008','65262','47884',
                          '23109','58106','96600','58341','75457',
                          '95641','79269','31391','92985','18031',
                          '60452','77282','74805','72852','48209',
                          '67069','81226','80204','24064','47201',
                          '87853','90493','13701','83365','39174',
                          '50460','62522','17066','55320','80320',
                          '60893','92446','45919','83983','35919',
                          '67019','91972','11788','52464','70652',
                          '68950','38457','53322','62500','48289',
                          '75777','63706','74024','64076','55794',
                          '42026','65212','40789','33584','75394',
                          '83350','44818','33211','65132','11050',
                          '47963','30611','56271','33643','31466',
                          '35333','20420','19646','36889','25979',
                          '51591','78808','34937','24990','42496',
                          '13308','61341','83698','28764','35081',
                          '90891','14803','33100','67228','85209',
                          '80397','54157','45804','67960','94588',
                          '50980','52619','56772','20584','91355',
                          '53535','95085','71480','98448','16660',
                          '14160','85369','17989','29675','47097',
                          '45843','26498','78900','85785','69841',
                          '52293','98371','78715','19532','95832',
                          '84616','52983','45158','98472','86490',
                          '28848','94233','51653','99447','44433',
                          '90726','25877','88899','48908','96093',
                          '61584','47007','70655','12256','54238',
                          '13995','47431','24162','88853','94418',
                          '47459','99595','49979','16377','36922',
                          '90231','95847','25863','97612','83160',
                          '38348','70440','26816','93589','95455',
                          '67085','41658','75152','43702','14355',
                          '76125','29418','60500','86425','55515',
                          '38163','29610','49798','44947','71599',
                          '95953','15276','34564','62888','49657',
                          '39167','36158','30386','77839','10823',
                          '27056','17083','68981','52177','26393',
                          '96701','47137','24955','86783','88723',
                          '41691','23293','64586','41063','13086',
                          '76733','12361','49825','60945','64797',
                          '34450','12645','63656','79822','27567',
                          '41223','41205','98671','67307','19507',
                          '58411','98763','19917','37813','85885',
                          '89085','30142','78214','40924','89269',
                          '60635','72826','86644','92983','58728',
                          '91801','69814','72264','12885','64377',
                          '74049','46632','72714','65989','87868',
                          '75291','68499','92887','29357','80877',
                          '32667','40019','77540','77583','23813',
                          '92140','72693','41417','48124','76003',
                          '22102','34424','16891','27272','17580',
                          '76584','91236','58457','40914','81694',
                          '80908','79791','72726','12680','47721',
                          '43893','21449','76213','33775','15204',
                          '56150','14493','49127','13056')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 8 in stream 0 using template query8