
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '25421','88786','58602','43520','82425','24217',
                          '28279','86323','75703','93186','71372',
                          '95837','17404','63051','27604','79557',
                          '73832','73094','68323','25541','90024',
                          '17609','24426','33245','64538','54964',
                          '93056','70784','58526','21752','48166',
                          '11083','14902','71398','33081','63938',
                          '21392','82381','48076','76160','46982',
                          '70781','95418','93198','79458','71816',
                          '94793','16555','93256','89129','57201',
                          '99467','60837','70914','80731','48507',
                          '10645','60336','94188','42069','28054',
                          '84516','40716','35218','76631','24728',
                          '18365','61632','95229','89177','34867',
                          '57123','33225','12890','24777','64105',
                          '43992','55547','44153','28410','43156',
                          '31483','33889','72884','63436','76281',
                          '28472','72802','53446','24285','98271',
                          '29586','85387','63136','16854','56240',
                          '15032','76111','49566','53420','82208',
                          '94458','58479','73841','14765','79673',
                          '96565','40866','33814','23233','40342',
                          '95757','98464','34549','32862','78618',
                          '16413','43326','80280','66560','19682',
                          '53987','89179','37554','95700','21089',
                          '47983','13433','65189','74505','31498',
                          '87805','14384','65643','26290','86370',
                          '24005','18289','74479','60022','97307',
                          '47873','83812','15344','40807','52244',
                          '25701','46252','63317','30086','99672',
                          '79822','86612','27060','25220','61676',
                          '31818','28315','51873','65555','94767',
                          '81510','63341','19199','26740','78733',
                          '82372','58704','31192','84338','64841',
                          '57061','83382','50857','47054','88526',
                          '99433','97301','25673','55439','38393',
                          '45813','45540','99986','59767','49860',
                          '96190','82394','82816','13842','24689',
                          '85900','20771','51861','15045','37237',
                          '87244','70350','98322','87717','72571',
                          '30177','90846','52804','16276','49736',
                          '65915','51046','48078','40676','76976',
                          '33749','38883','42794','82335','53616',
                          '47498','79467','22672','12594','97760',
                          '91245','70478','21069','55457','40436',
                          '39040','41777','86065','19495','82241',
                          '55435','36782','72705','27871','81283',
                          '25626','33084','16875','56071','66779',
                          '47109','34189','83842','75650','73735',
                          '41421','14781','56294','99107','28151',
                          '85484','38631','56344','14843','22402',
                          '37932','26426','78047','84936','17250',
                          '78713','85310','77172','74734','84246',
                          '28391','25011','40566','52863','61936',
                          '94156','53645','35967','18364','22019',
                          '63334','38013','23850','87369','37801',
                          '19188','65537','13950','99367','88168',
                          '57591','66309','89429','34636','30868',
                          '20631','41283','46054','20386','61075',
                          '84052','90379','77334','57795','32216',
                          '84709','68970','56085','92523','49535',
                          '13985','47318','97483','65842','87893',
                          '81779','33851','14650','10242','27850',
                          '27745','34190','28678','92163','86360',
                          '99544','91648','89040','12464','77139',
                          '51744','80082','96428','63104','11309',
                          '52034','40783','23816','56880','77290',
                          '36900','50496','65147','78815','53597',
                          '76420','13440','50074','39351','48378',
                          '68526','84393','46890','14272','31342',
                          '59145','46895','54486','65251','90271',
                          '31935','97209','23713','30530','90811',
                          '34583','45720','65037','77395','39137',
                          '93426','47827','54296','66940','41474',
                          '81134','93349','53495','56239','77669',
                          '84598','60932','48336','88029','77110',
                          '54439','19951','74768','53562','45148',
                          '66971','16613','61940','72330','99874',
                          '55981','87302','56884','99105','89349',
                          '52986','31326','64343','27392')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 8 in stream 0 using template query8