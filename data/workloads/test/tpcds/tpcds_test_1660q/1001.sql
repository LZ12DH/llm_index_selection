
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '95642','83870','94370','53985','52035','22414',
                          '25149','45360','90076','43044','36233',
                          '54039','18042','58715','37853','43797',
                          '90298','81281','10859','45044','62141',
                          '12862','97910','59471','37089','52262',
                          '40528','59378','31844','77455','61485',
                          '14771','43772','87772','45733','82435',
                          '86890','89219','98461','45861','32867',
                          '49250','20824','59345','45959','77763',
                          '68388','29843','86529','95357','20101',
                          '85079','25768','60923','68664','80085',
                          '87497','20958','59340','28104','72172',
                          '33041','35362','31833','29016','89678',
                          '93164','72283','60991','18755','72017',
                          '53861','27587','59834','92596','65061',
                          '74647','87609','27346','78991','83784',
                          '81229','69110','24824','24679','60648',
                          '66328','89122','78212','57674','57982',
                          '59869','28046','74097','46167','40319',
                          '68811','13923','56418','84834','25944',
                          '77336','95793','43077','19112','77894',
                          '13570','66901','64136','38181','12840',
                          '26011','30141','14210','66838','90459',
                          '47597','45491','56738','57220','19151',
                          '42679','22215','74636','16447','61452',
                          '81379','60178','38710','26211','58718',
                          '35988','29726','26363','49830','37998',
                          '27894','41650','33334','29437','92620',
                          '40142','41088','74060','55566','38702',
                          '61433','28173','26241','51587','91114',
                          '81778','44709','61930','70255','88867',
                          '94622','33288','66347','59619','56929',
                          '98275','35604','34729','75354','32203',
                          '38516','91009','67954','98415','68568',
                          '40874','83858','64234','35236','95540',
                          '22714','72370','75169','42717','65140',
                          '11086','58278','89216','62656','55352',
                          '71554','23869','55745','47298','54332',
                          '94326','29943','18280','56679','41056',
                          '11048','30103','38801','90358','73414',
                          '74285','23341','53795','10266','37795',
                          '49187','44011','46300','66958','74277',
                          '63136','40046','28605','52256','26139',
                          '82482','86896','34210','32858','94085',
                          '54603','36117','92264','85522','96087',
                          '75940','59099','32028','76931','92953',
                          '46878','78293','99517','65374','46995',
                          '24235','58500','89801','27779','41528',
                          '17269','25487','65784','14846','51039',
                          '46496','50593','78401','42774','48852',
                          '54182','26866','54827','96114','35731',
                          '65595','27539','23427','10077','33964',
                          '51705','80279','98312','53087','93402',
                          '48829','30967','20611','63740','40098',
                          '29537','56513','98608','41731','25975',
                          '32251','52031','70387','86625','63489',
                          '49068','23577','11439','69659','72631',
                          '21244','54131','46277','33655','15040',
                          '60109','95989','49041','57486','35998',
                          '59426','25466','42436','17767','19368',
                          '78702','66673','66550','91724','42703',
                          '13461','68357','55457','22032','55149',
                          '49992','62534','19855','49870','70981',
                          '86795','95886','17467','93574','97042',
                          '79023','85275','66480','77855','18013',
                          '41683','51958','14944','97355','67386',
                          '69284','33805','48491','30378','54086',
                          '84969','45629','66275','57596','95710',
                          '79913','82720','56624','33881','43724',
                          '80736','60004','90103','58761','27842',
                          '34673','61676','65497','39671','40918',
                          '38488','35743','59336','99949','72641',
                          '87451','70634','74737','33912','26412',
                          '23274','85415','29029','99767','96471',
                          '29617','79775','30438','21926','17546',
                          '84103','77013','89899','94533','34751',
                          '70619','57255','31823','44113','71388',
                          '32722','16785','46013','93793','34335',
                          '75782','85963','41248','63337','57348',
                          '71656','71243','89127','81276')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 8 in stream 0 using template query8