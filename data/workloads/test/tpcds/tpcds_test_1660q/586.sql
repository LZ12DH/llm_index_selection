
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '61492','21062','67906','10196','61650','47753',
                          '72258','45561','27906','82914','82832',
                          '69389','81380','41766','24929','11679',
                          '95018','87539','91607','13163','38588',
                          '12573','72715','33236','19385','73817',
                          '53759','74215','96218','94751','44013',
                          '78543','98434','17654','38947','27156',
                          '99257','52420','87910','54864','23709',
                          '35433','57751','59630','47536','76159',
                          '67969','73320','80445','18053','13601',
                          '28150','88830','89430','53438','37150',
                          '27336','84958','98050','54653','20973',
                          '16218','77408','72694','37026','77174',
                          '20500','67628','27118','79777','88117',
                          '78895','16308','18455','26395','27162',
                          '47774','37604','60439','57033','47756',
                          '19297','41865','50947','17382','19899',
                          '34120','72411','76785','50886','85831',
                          '99513','35645','26305','24783','62039',
                          '69474','31798','23455','95009','11097',
                          '76864','85301','32652','16940','63040',
                          '63559','24601','58474','10169','41786',
                          '79614','16365','84379','13628','87785',
                          '64948','98489','89141','66685','32673',
                          '91437','28911','19121','19130','92260',
                          '72600','69601','27402','20980','60766',
                          '26299','51071','14410','80366','34677',
                          '25903','57117','25751','53821','51258',
                          '64017','14655','30703','57177','84609',
                          '10103','95785','51453','44357','33453',
                          '62792','56358','36659','15253','51655',
                          '58475','55730','24603','73508','97017',
                          '42800','18520','85306','35494','43673',
                          '39010','65804','47093','68247','34422',
                          '30930','90485','47915','98933','35846',
                          '81278','29267','39159','46371','58308',
                          '25261','69890','22582','69679','94102',
                          '74597','55823','47499','71691','72935',
                          '29179','95833','31226','90003','11545',
                          '52801','64320','93155','37522','11058',
                          '67718','11905','66550','37624','90624',
                          '65033','49173','20609','81774','31282',
                          '58773','13015','81978','66145','96029',
                          '33075','65328','42463','72612','64300',
                          '43103','66300','34331','79654','23391',
                          '18514','47814','21558','45812','31265',
                          '30823','54965','83212','52021','22247',
                          '70354','60268','31455','37372','65226',
                          '79836','60471','29905','82337','55942',
                          '64597','94671','36960','50285','86681',
                          '72032','42321','63748','64321','69238',
                          '52205','75000','46741','38091','17485',
                          '94402','21774','93092','75080','21064',
                          '53816','15126','68754','76167','98920',
                          '59714','41538','34388','33778','57879',
                          '76101','72331','69435','53900','80237',
                          '18680','59506','39846','56782','47611',
                          '32330','97989','45317','94943','17220',
                          '64304','86349','75783','94676','26368',
                          '35933','85079','32594','98632','64230',
                          '23556','82893','73807','96298','10037',
                          '18989','67590','38659','82927','35651',
                          '62790','83522','18361','59221','61665',
                          '53098','29694','37901','68944','39367',
                          '67583','45132','36514','75218','61682',
                          '10566','35659','95546','19289','84961',
                          '13844','33937','12749','14984','65617',
                          '96803','90192','39899','99885','93418',
                          '44900','44238','79810','49153','40394',
                          '14044','82315','96928','79031','35393',
                          '23777','12376','48481','37749','78505',
                          '92424','46063','15607','94165','26429',
                          '77103','31719','23680','38156','39260',
                          '39890','52633','56950','50177','93217',
                          '54812','87506','61133','66177','78927',
                          '36884','89198','21128','19624','76195',
                          '54166','79092','65721','92752','15446',
                          '65257','61496','20677','99805','48406',
                          '47046','71967','72729','51557','36194',
                          '41217','43492','76845','70849')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 8 in stream 0 using template query8