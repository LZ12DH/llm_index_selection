
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94910','91639','48409','94772','52019','84970',
                          '75668','45499','93748','91506','91283',
                          '76319','86707','40182','10476','86868',
                          '92580','63649','23778','67627','66367',
                          '85056','23790','62984','69673','23808',
                          '33457','11324','87055','97443','24492',
                          '36107','82784','83843','68549','24573',
                          '72924','56404','17164','18984','14863',
                          '99656','60727','86267','28171','65209',
                          '12958','97256','24167','93446','47856',
                          '27553','74542','44831','33082','36865',
                          '67304','28486','94165','26063','26314',
                          '22650','70300','50380','16070','43909',
                          '22156','14682','88458','49169','73205',
                          '18173','99318','29590','52819','26579',
                          '29835','23298','72243','25572','37916',
                          '70230','44984','76075','69755','57339',
                          '34043','88799','10709','95727','81130',
                          '95115','85001','58285','17226','81338',
                          '63833','45162','19837','39034','85427',
                          '76667','43170','51058','79136','26887',
                          '79042','37357','42324','27497','21262',
                          '33879','44058','90009','51228','63148',
                          '27149','32293','13484','90952','42800',
                          '82920','36782','94744','98321','71639',
                          '27907','59245','18687','39396','15920',
                          '17118','17778','84771','84116','27522',
                          '83037','78601','18827','52352','80607',
                          '26500','83053','42413','30167','37731',
                          '87076','47907','97244','65484','20765',
                          '18485','52894','10272','66652','84584',
                          '66959','18186','23606','76444','78873',
                          '99395','58800','11480','50363','43716',
                          '29037','30216','96433','63262','33466',
                          '72666','94655','11513','66150','36099',
                          '67392','17385','30783','80226','28213',
                          '66873','37185','75279','21734','88874',
                          '66581','86731','21069','47596','38184',
                          '58097','50435','98306','15046','33237',
                          '71770','73141','18110','23440','57767',
                          '41367','90881','17484','58567','12789',
                          '22502','18456','55107','60368','32257',
                          '87344','65062','45972','43872','36051',
                          '67918','64236','85576','44476','79738',
                          '52009','91444','30053','73662','40730',
                          '80586','75761','11972','45061','73114',
                          '40882','89878','96926','10109','55829',
                          '39625','10010','61591','84328','33516',
                          '34229','82299','83894','43348','82945',
                          '51536','16597','38598','91430','19438',
                          '23912','59776','58474','45674','29614',
                          '26611','57017','66640','33671','59050',
                          '76067','62110','37534','94477','37528',
                          '51808','16477','92525','10270','89213',
                          '71332','32134','30294','16203','67638',
                          '87787','90470','90255','29945','35973',
                          '75451','44046','90932','67187','42989',
                          '67238','75423','13740','40036','79023',
                          '31230','22011','22715','20106','63229',
                          '48344','74536','11037','98543','16628',
                          '32118','41699','88569','39017','67096',
                          '51475','92864','15483','39265','53832',
                          '56352','29107','37877','70121','69654',
                          '71560','37705','77040','41374','46039',
                          '79421','97945','29067','61980','25819',
                          '62580','13014','46366','13461','80709',
                          '57323','42582','45465','30109','21884',
                          '83563','57405','65001','27822','75726',
                          '42817','46639','64678','68914','39209',
                          '23736','36614','58369','54649','68726',
                          '64895','96537','38347','91723','93286',
                          '57751','75638','14896','48388','49953',
                          '97365','65967','38853','18549','31089',
                          '96527','62237','87885','29028','36764',
                          '61024','46896','45045','33165','17278',
                          '82636','26172','10421','80496','52845',
                          '58062','63802','64340','47996','33996',
                          '93513','35549','83818','57784','88191',
                          '31223','52779','35356','60211','91163',
                          '94922','89839','72696','88017')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 8 in stream 0 using template query8