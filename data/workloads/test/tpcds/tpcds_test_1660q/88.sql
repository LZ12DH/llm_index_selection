
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '35083','11602','93910','98560','21799','21414',
                          '97200','88925','61701','13052','29550',
                          '52067','66718','81390','15522','25431',
                          '88049','97464','14933','92446','96749',
                          '13657','26360','47267','97668','80711',
                          '96173','12595','39394','80490','46774',
                          '78594','62429','77485','35449','65966',
                          '37364','40710','42460','71006','72645',
                          '85819','49527','82329','58004','42386',
                          '74599','11291','92098','44875','93177',
                          '98564','76104','23249','88149','72695',
                          '23000','31860','85793','20596','85160',
                          '50249','40633','25870','74839','43164',
                          '63143','42978','98436','21907','18155',
                          '70622','46743','61667','86609','22652',
                          '92055','67062','53171','50184','34781',
                          '60547','84335','57536','48668','10178',
                          '56177','93297','66430','56121','91057',
                          '90950','25636','88702','17646','73925',
                          '36999','62581','26395','98886','23259',
                          '66532','43109','53715','19658','26787',
                          '10354','63950','64924','19204','33285',
                          '62133','38408','80957','71696','45234',
                          '88142','43869','35626','91301','24656',
                          '83167','58437','74120','42526','35002',
                          '10431','55508','15055','50482','51735',
                          '10764','73949','12881','50119','70723',
                          '37436','63256','96299','20130','93964',
                          '16324','20469','57733','15077','86668',
                          '89643','62870','64094','34674','88720',
                          '28448','80024','57550','21487','34398',
                          '90971','75374','84767','72672','72342',
                          '65904','73261','94030','57781','35140',
                          '17422','89549','11978','45308','55419',
                          '77328','64894','80479','79177','28791',
                          '79730','35639','67250','31121','54867',
                          '96978','64543','85669','46114','83913',
                          '10890','62068','74644','85173','88465',
                          '40853','88539','86639','23488','43789',
                          '86596','97055','16938','59181','78310',
                          '48270','72416','12526','53175','25350',
                          '88257','54353','22865','39109','41481',
                          '96949','11255','55663','56876','30277',
                          '29097','69770','41031','72546','54351',
                          '65149','32309','34588','12622','61199',
                          '39922','79226','51475','71980','84363',
                          '91268','84320','72070','11191','66435',
                          '18257','52645','15169','83698','40494',
                          '67006','63045','34284','55840','77450',
                          '71997','77402','44930','34976','67841',
                          '51299','60959','62273','96383','98268',
                          '26328','47819','33937','27816','28833',
                          '52851','65646','61881','17922','38915',
                          '84012','26376','64734','83430','65733',
                          '24967','47456','60802','83378','78456',
                          '92793','63127','16927','49719','30605',
                          '30767','55885','40129','82334','53569',
                          '52147','70854','55255','22850','38723',
                          '85421','38580','52053','67445','81998',
                          '71902','22534','39263','21746','16478',
                          '34581','85798','11584','38877','15802',
                          '51615','53141','41974','10927','34303',
                          '88136','21174','68698','25686','50888',
                          '36700','21183','53519','40366','12366',
                          '63753','80781','86190','71147','27012',
                          '99611','99048','62424','11985','62906',
                          '40760','31706','11339','43291','59071',
                          '76135','71612','15750','16866','48772',
                          '99409','20864','18922','48960','74326',
                          '45548','50414','20675','38554','48272',
                          '80364','19677','36536','38187','41624',
                          '22642','81352','37924','66999','40116',
                          '85666','24851','88652','10482','67935',
                          '16517','33622','90785','12819','35020',
                          '78508','14516','81631','15771','86778',
                          '54423','35202','57147','51724','30303',
                          '39154','39280','41166','15192','41451',
                          '11334','47061','88837','82659','39815',
                          '39470','34165','38108','59899','74158',
                          '17262','10827','83720','96370')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 8 in stream 0 using template query8