
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '36645','84908','34758','11319','70811','10358',
                          '35957','97320','50158','83508','77749',
                          '45338','81539','43871','11594','90727',
                          '80476','88803','82976','18741','50986',
                          '97070','15418','91192','75178','21057',
                          '40146','44740','14488','50643','44762',
                          '66461','66153','68938','49216','88045',
                          '29494','40894','98786','12597','66179',
                          '52142','28662','85843','42030','71411',
                          '62425','43303','56777','33283','29228',
                          '58898','32835','94721','96274','31209',
                          '99308','36963','69624','51364','64789',
                          '16470','82874','87820','33168','60705',
                          '70914','73402','68568','20531','68516',
                          '17643','66814','70845','90420','95140',
                          '46412','31430','25005','75331','68717',
                          '22451','94626','29299','90433','37103',
                          '17746','71719','99017','14388','21650',
                          '89370','97147','70412','49698','53025',
                          '96013','51903','12002','97360','98292',
                          '13929','96996','59089','13154','36268',
                          '20324','26948','19760','48472','57960',
                          '40201','17032','76808','13237','76205',
                          '81442','80179','36561','23047','67543',
                          '76372','98094','11732','81610','90225',
                          '63855','19236','25786','31311','13994',
                          '31865','87359','86210','11344','64715',
                          '77593','34326','38054','36106','39179',
                          '57632','31742','16991','11579','91614',
                          '97071','65041','55047','76406','67283',
                          '88154','86900','93849','79688','60156',
                          '59939','31347','83312','13708','45823',
                          '69406','78695','18365','40640','39221',
                          '25460','79706','50431','79696','20706',
                          '82974','50531','39930','65229','79313',
                          '16989','54660','18063','87159','55827',
                          '23600','17423','78251','76458','83149',
                          '71281','29768','45578','73597','62646',
                          '38109','77983','96930','25069','12412',
                          '57213','57034','24797','15547','49104',
                          '13149','20919','28171','31037','57449',
                          '91361','41464','13425','51688','63025',
                          '29694','89759','95569','37229','92366',
                          '45687','33734','57080','57030','73664',
                          '87832','30749','64129','30395','57053',
                          '67062','15379','94364','91418','34323',
                          '30807','14792','10815','78376','19496',
                          '52672','26078','50908','12012','58162',
                          '73988','52399','54816','21547','57388',
                          '50956','42332','95765','90996','82849',
                          '43119','57975','60550','20566','35635',
                          '74210','52534','56224','59312','61608',
                          '53313','93172','19455','33294','90063',
                          '39108','22077','20684','38412','90963',
                          '31961','84882','29739','28074','41468',
                          '60333','10616','73345','47358','57445',
                          '64657','96335','96691','87028','55322',
                          '36414','83983','94557','71474','94078',
                          '32951','49223','65279','61278','19474',
                          '71450','36433','82043','96418','33198',
                          '11930','98914','19068','23863','72251',
                          '67431','12277','88408','82568','14758',
                          '66061','89722','26920','14063','79855',
                          '81779','34072','73284','53446','41465',
                          '39810','80843','18762','67623','32712',
                          '36281','82595','95974','70670','70859',
                          '96130','25486','67723','10617','77357',
                          '34156','44442','95008','93179','82162',
                          '21733','19997','62714','43806','65120',
                          '28840','84012','55771','42560','12644',
                          '25760','24053','88269','86514','78157',
                          '61453','31743','32961','45431','55973',
                          '15755','85047','82093','72130','52374',
                          '22382','54264','83801','35961','65183',
                          '81122','96555','31723','74334','20168',
                          '21031','56846','15840','13110','23367',
                          '52090','11761','70998','93096','38678',
                          '23033','58208','37319','37845','15507',
                          '11782','34032','36549','97174','43067',
                          '17221','28582','61124','94781')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 8 in stream 0 using template query8