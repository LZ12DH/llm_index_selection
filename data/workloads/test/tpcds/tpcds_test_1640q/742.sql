
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '74243','25714','74882','36522','76552','29860',
                          '14270','38761','27158','53429','58618',
                          '23773','83233','30645','85301','88378',
                          '46959','65391','71674','87300','28801',
                          '10274','17148','63821','13381','37430',
                          '68872','93867','76002','32900','72709',
                          '31167','44845','26094','40265','43489',
                          '98046','28918','49310','64606','88964',
                          '28692','26470','49020','85911','60781',
                          '72174','45490','79249','84652','97521',
                          '92695','22968','99781','83057','14562',
                          '74645','15804','65337','31432','49761',
                          '14079','92186','83927','20432','60607',
                          '55671','24907','45388','80951','24463',
                          '67519','99380','89489','10034','32620',
                          '13575','19447','94277','51687','54727',
                          '75828','93934','69502','57677','27974',
                          '75829','48284','97207','50732','51246',
                          '64452','47312','32411','23474','50233',
                          '85818','68665','52178','49501','94520',
                          '17797','42632','91623','64503','66887',
                          '56111','28513','20069','14655','96057',
                          '16524','12954','69661','95464','45905',
                          '65548','58648','77299','60364','88000',
                          '16640','35176','27409','46787','67198',
                          '47762','54177','29213','17945','75592',
                          '27697','89201','40152','89805','40239',
                          '72917','62182','98254','11919','71501',
                          '40669','97179','17164','40744','95903',
                          '36984','26297','82924','77753','58912',
                          '67602','96693','90269','12895','39803',
                          '34550','77885','57505','16906','69554',
                          '66907','45290','93892','80672','25049',
                          '89877','17102','30493','13526','29665',
                          '12017','75528','36274','47024','63657',
                          '83461','57596','19744','49737','61504',
                          '83249','91845','52556','11365','94630',
                          '48113','65763','81486','58197','43038',
                          '72686','41072','43530','59919','92866',
                          '94301','75118','87136','43487','29578',
                          '36214','54161','21691','20747','65158',
                          '98464','74301','20742','61323','61297',
                          '71761','27790','26520','95032','24657',
                          '69070','92812','54565','57827','52481',
                          '10816','86127','73664','35156','72631',
                          '68827','11908','95498','37883','71712',
                          '16537','86469','57466','60102','72571',
                          '14653','78841','90285','12082','99421',
                          '44673','17907','99656','65725','22675',
                          '90013','53316','70541','62070','23659',
                          '67322','57441','92629','96934','35611',
                          '83325','65966','92242','85560','60681',
                          '56529','96957','91886','22193','98020',
                          '44335','45384','40756','45517','99047',
                          '70707','24924','26786','89606','15742',
                          '15448','42316','93786','89677','94266',
                          '21626','62569','88699','33176','49446',
                          '14348','45752','32916','10465','95181',
                          '48331','99087','63217','91639','63486',
                          '78569','24300','18769','24971','48381',
                          '96420','87984','54475','18548','83037',
                          '66594','53217','47642','92467','97425',
                          '43884','64335','25320','75542','41409',
                          '77505','38018','57419','26407','53419',
                          '90312','76055','37304','15587','15400',
                          '69346','71938','95779','75505','17788',
                          '18260','54584','58893','48126','20226',
                          '93182','39997','17877','94709','17226',
                          '35444','41201','86309','60885','91318',
                          '85559','53271','76784','54337','96717',
                          '32108','15861','96462','66392','92905',
                          '53845','56468','79301','32924','79558',
                          '29122','66352','15567','30817','95517',
                          '77816','68311','67275','79145','52111',
                          '13281','50217','65160','65067','91843',
                          '22163','38954','91184','88707','92446',
                          '68354','28042','46039','25089','75155',
                          '67494','83014','18021','39574','75244',
                          '23458','34061','90382','42282','24734',
                          '36843','50389','19413','57097')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 8 in stream 0 using template query8