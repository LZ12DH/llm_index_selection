
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '74076','26225','63644','43977','78151','65363',
                          '66408','33108','74212','14232','59703',
                          '21553','20242','37191','52637','39205',
                          '58365','98049','61955','74192','94261',
                          '32302','24651','26313','82481','31634',
                          '25922','54491','60325','69184','84144',
                          '84799','80510','31391','69023','66833',
                          '13728','52024','20855','56933','83294',
                          '16085','62642','35898','75978','87803',
                          '92723','79071','72927','80880','76154',
                          '82672','29465','38625','45997','88453',
                          '91540','56817','24173','44816','55986',
                          '75582','69521','66469','76135','75327',
                          '83207','25097','12467','82001','15220',
                          '48726','65640','24285','40974','57582',
                          '47467','21028','12088','98785','57215',
                          '70569','58216','10193','40284','82521',
                          '79359','15431','99459','62604','69141',
                          '28245','67138','86649','86519','91355',
                          '16613','25342','67362','10043','92187',
                          '45156','23407','75575','59250','80822',
                          '12928','33343','98990','99362','22718',
                          '21606','95467','99745','94514','41970',
                          '94100','91953','81284','98180','58743',
                          '33443','33670','38822','48308','42254',
                          '58388','96842','51595','92810','98080',
                          '78255','48878','44847','88572','60751',
                          '51833','51055','77176','80172','19151',
                          '11243','53306','60196','34527','36215',
                          '96557','30053','98857','77008','17262',
                          '27267','64213','45968','53663','49900',
                          '85254','63965','24691','10922','88946',
                          '92628','91647','74729','46192','90345',
                          '15569','73831','23800','30767','83233',
                          '15723','17447','84040','81904','95212',
                          '59202','17669','79678','44508','69977',
                          '70867','12436','77294','20475','64549',
                          '92570','95753','80177','77534','49947',
                          '26657','63298','11125','50436','37782',
                          '16536','44952','44971','52455','56575',
                          '34802','24209','84955','83782','54220',
                          '99412','99248','32813','71807','76210',
                          '87550','99164','43764','51510','71372',
                          '70468','35595','34764','99967','93053',
                          '76020','55543','31889','75240','90654',
                          '14517','93313','57708','76247','20012',
                          '40105','67801','23200','87131','39152',
                          '94131','48449','34745','27456','58602',
                          '74319','25324','16952','29287','43597',
                          '73953','10679','45590','11879','39197',
                          '27756','58267','62561','59993','70231',
                          '87196','33373','36639','73264','11409',
                          '30802','31636','27872','94398','89878',
                          '86384','47421','73404','84288','20959',
                          '62045','58948','37646','80383','76486',
                          '15458','90450','30075','35557','27971',
                          '23947','39800','76781','41211','76963',
                          '12387','65742','10181','61237','49405',
                          '70246','57875','75285','38040','34434',
                          '73361','50675','84106','51557','63016',
                          '48070','49696','37772','43926','65952',
                          '85704','68931','86034','63752','23289',
                          '11238','27787','25630','64493','69334',
                          '86923','73036','97449','37402','24274',
                          '56182','22729','12200','27348','83973',
                          '20104','90336','10226','27929','49278',
                          '38575','91655','59184','38377','12224',
                          '54229','33247','58598','97120','57584',
                          '71298','19368','96463','64869','58498',
                          '74711','17483','29317','35279','72244',
                          '59350','70042','52661','10561','74018',
                          '30756','36991','76142','92882','80511',
                          '30006','67832','84000','21070','27808',
                          '84543','82579','43870','40221','66732',
                          '72148','38411','99655','25870','38442',
                          '41133','51388','52519','94476','59032',
                          '79105','53707','28513','18878','83177',
                          '95421','23469','87797','45576','19276',
                          '23392','94826','58245','85797','94475',
                          '36157','27585','22663','30909')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 8 in stream 0 using template query8