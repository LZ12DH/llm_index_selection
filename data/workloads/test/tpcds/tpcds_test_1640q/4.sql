
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '22449','74533','63385','19062','99031','75857',
                          '56729','48923','68350','66261','35016',
                          '44742','54932','87198','16221','16727',
                          '96536','57662','31131','86153','53866',
                          '15484','36533','63175','52468','66087',
                          '16677','78514','21396','20057','28042',
                          '81513','28178','16626','80860','24290',
                          '92366','48494','38873','91104','17146',
                          '97221','66510','39668','61745','18921',
                          '12850','44129','59400','86725','56690',
                          '44238','22674','25732','32753','56759',
                          '20740','39549','46884','97537','68674',
                          '71887','86222','12390','24974','32065',
                          '21570','16795','41586','80017','77488',
                          '87647','87923','15271','83161','14448',
                          '88205','55966','25636','23304','41208',
                          '78499','92074','94106','66682','21354',
                          '17865','92773','19496','14322','99243',
                          '40459','66610','58369','79066','62845',
                          '50699','57109','25369','57602','80902',
                          '11531','90732','28871','26588','53142',
                          '45032','16721','62282','14685','70153',
                          '79387','65768','96613','13384','18561',
                          '10564','50099','70626','56640','66922',
                          '73495','34747','10605','56313','85506',
                          '59403','21045','27452','93021','89764',
                          '55614','67973','48158','67800','69787',
                          '48836','88661','51882','17017','88526',
                          '39602','71621','61002','26888','64050',
                          '56156','11196','73958','90793','56914',
                          '32623','42739','71472','28423','78580',
                          '63322','22087','90609','63979','11655',
                          '11387','80919','40892','79520','24266',
                          '45606','70010','24108','12341','45846',
                          '82500','86901','34243','57788','23932',
                          '22911','15279','87835','92481','67699',
                          '47528','12629','29214','72653','29269',
                          '54228','80072','50145','12964','19377',
                          '70594','41602','61390','79320','79025',
                          '74919','49501','49512','14619','91013',
                          '10981','45061','96655','23581','37236',
                          '59210','67114','17382','27963','17806',
                          '70726','80465','86729','49199','49951',
                          '18305','16684','74915','24514','32841',
                          '90210','22851','36435','95206','76868',
                          '29008','18940','74532','73992','81709',
                          '11172','13633','51296','65407','35853',
                          '92468','61918','13168','47233','97639',
                          '70966','24034','53880','22977','48941',
                          '26108','30564','13860','49545','67597',
                          '15711','57703','31583','63494','41128',
                          '46478','69552','34935','12943','56800',
                          '50026','78919','77919','79410','31476',
                          '34796','54525','80817','35562','52115',
                          '47457','89328','85529','96555','51480',
                          '15292','61932','22269','35784','85797',
                          '37604','21522','56771','78537','11695',
                          '50929','11458','65331','58169','12191',
                          '33562','46778','24366','78571','29330',
                          '94780','38886','59368','16933','49697',
                          '92369','18942','18070','21228','17043',
                          '73656','57257','30986','50965','18767',
                          '44979','13493','99788','12472','51562',
                          '91878','53469','69413','27984','29023',
                          '57811','14099','80826','36231','26903',
                          '49150','21474','25800','79401','47547',
                          '90211','27609','40330','67234','61497',
                          '54541','45054','48906','61711','62758',
                          '49957','78191','30711','26067','59968',
                          '56379','10740','26066','52415','96664',
                          '54710','65486','71453','96912','33707',
                          '62335','94918','76915','20964','43373',
                          '79652','29372','50834','36440','60111',
                          '15185','28732','33906','27767','56434',
                          '95807','74627','82150','48853','46530',
                          '20544','94413','92021','27426','47844',
                          '27215','64539','87942','54917','59093',
                          '46334','56523','31236','73455','46272',
                          '34152','36568','22961','15108','19660',
                          '86281','11465','75770','13792')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 8 in stream 0 using template query8