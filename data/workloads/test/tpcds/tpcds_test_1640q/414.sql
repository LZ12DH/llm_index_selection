
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '16105','97093','57146','60825','17899','52860',
                          '34429','34104','71421','76094','73544',
                          '68632','38727','96754','55095','13733',
                          '54837','35243','92385','16172','12843',
                          '32804','35424','98406','57528','86926',
                          '52781','43429','53953','75140','50425',
                          '68692','58066','85146','94674','96213',
                          '24766','47749','73804','56584','80335',
                          '77785','67036','78316','94293','11355',
                          '51447','26774','69357','17871','92327',
                          '87382','34037','54409','28580','32355',
                          '11667','61149','60708','53413','87093',
                          '93858','81060','63532','50880','71043',
                          '11054','37208','16840','23145','62518',
                          '77573','99620','24057','72400','76270',
                          '28110','73997','83912','22713','79343',
                          '89586','80552','40504','68130','30597',
                          '90434','50715','15333','15739','75745',
                          '37924','20042','79300','63620','95887',
                          '17843','27855','17662','43194','56539',
                          '30379','22474','61055','50354','57392',
                          '21793','87844','57207','54530','21370',
                          '93508','86391','20300','34539','36673',
                          '85314','75072','46073','30551','77299',
                          '20478','43243','92485','66611','32635',
                          '23751','57177','83076','87722','38942',
                          '62999','22074','43402','32346','81855',
                          '83577','97123','60248','32031','54992',
                          '12783','73395','71768','15958','85059',
                          '70586','90355','71507','20069','50370',
                          '62647','16484','25399','82141','61568',
                          '49577','74290','21882','32284','31693',
                          '72445','96006','43379','18086','84615',
                          '93051','91809','24314','86397','93220',
                          '50615','27848','51774','99886','97005',
                          '96341','53059','61783','39503','79989',
                          '73436','78013','45284','98822','18989',
                          '99975','40330','79694','56249','10862',
                          '65794','25158','81592','66137','79911',
                          '56654','45733','94676','42428','47075',
                          '19836','98913','24982','92278','98419',
                          '36161','25637','16969','98162','92974',
                          '11236','85276','10994','33519','17794',
                          '16378','13623','40067','16775','35524',
                          '27735','91866','99804','38265','63550',
                          '70058','71751','68421','60357','68746',
                          '25848','71045','27489','59624','54310',
                          '92316','82533','14489','34070','67422',
                          '61929','59876','15318','11313','84354',
                          '22615','93965','56811','44791','68285',
                          '68084','31541','36656','35802','27400',
                          '54808','64514','23176','52350','39916',
                          '75960','56265','69069','31276','15691',
                          '93389','92383','48120','73292','12001',
                          '58463','28464','62143','23045','23839',
                          '70204','21624','54391','73286','73126',
                          '41364','16321','51252','86997','70183',
                          '17131','20897','35023','36126','19211',
                          '40425','28476','12223','86109','76725',
                          '61342','98246','11755','37331','16839',
                          '16084','36480','23037','42478','68041',
                          '16289','89918','81022','86566','75736',
                          '62147','81491','64369','17291','71781',
                          '23814','94498','44706','83449','40098',
                          '11267','31601','64505','46422','57191',
                          '95541','72399','50733','84762','10111',
                          '86535','74167','20678','27261','52348',
                          '29343','41612','88458','87888','58861',
                          '99474','86232','17589','18633','50887',
                          '96623','98068','67353','32046','50875',
                          '41870','51959','89505','61945','17031',
                          '66680','87313','99027','13760','81867',
                          '59944','20436','14784','80035','16284',
                          '97925','91986','44766','52115','25012',
                          '79384','13528','33897','18913','25357',
                          '54555','77718','28842','52213','14224',
                          '77852','39752','77656','13386','62541',
                          '46240','30967','77466','82661','95168',
                          '61399','62685','82187','32820','97675',
                          '42290','86695','13146','56499')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 8 in stream 0 using template query8