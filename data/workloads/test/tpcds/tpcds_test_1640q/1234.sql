
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '32323','96944','38153','33154','88007','31833',
                          '80356','74798','20549','16494','89705',
                          '91987','48187','35462','50526','50133',
                          '92540','57587','86248','23430','83068',
                          '33007','49268','74038','51398','62875',
                          '99278','69682','84330','88346','53932',
                          '40600','56912','87176','38399','69805',
                          '16111','81326','68439','12619','17707',
                          '77607','58241','96112','63938','66242',
                          '54612','21006','90395','26030','70807',
                          '58716','13848','86502','67669','32977',
                          '39940','33810','96071','42341','85810',
                          '10291','74514','87668','26024','85767',
                          '11115','95036','13116','76764','61155',
                          '59151','32928','70572','26631','44352',
                          '21386','90593','44718','70933','23714',
                          '65867','97078','86905','45512','30422',
                          '14045','26669','30839','56150','93700',
                          '83823','71878','97684','16108','58064',
                          '45358','13979','15171','84153','16849',
                          '79024','80891','65576','34978','78843',
                          '27509','20205','61742','43109','36528',
                          '40225','49682','15055','49033','41847',
                          '24468','80854','38744','72439','64042',
                          '72676','48571','19294','36589','59208',
                          '92729','52085','65433','50745','20662',
                          '96264','77086','52991','94741','66720',
                          '28598','26037','72761','82334','20654',
                          '45822','68336','26655','76336','96566',
                          '11251','61298','15194','18558','88724',
                          '82994','70609','15272','72156','65220',
                          '38449','56112','23782','11886','21233',
                          '92745','22121','57377','94170','95282',
                          '88860','41893','51486','93392','19225',
                          '67133','83309','65608','60586','92199',
                          '53791','80047','20476','79366','61846',
                          '69473','55373','14108','27664','95068',
                          '33687','87716','41558','42260','74857',
                          '47683','94671','51962','14715','99510',
                          '83567','41264','21258','94000','63426',
                          '12858','39455','60040','11435','65512',
                          '86085','56682','41450','60458','21311',
                          '69096','26126','48526','16102','94768',
                          '80382','33666','98273','47329','87533',
                          '62030','74699','34043','88404','65126',
                          '27935','90664','51477','51960','46907',
                          '63553','98951','79509','47484','36275',
                          '99351','59068','97266','30692','80260',
                          '60653','99852','42944','22703','62705',
                          '44677','61262','45342','82224','65747',
                          '33934','39156','98132','52801','31923',
                          '90493','85217','95416','53368','65300',
                          '96293','68872','22909','82867','24957',
                          '60405','68438','40304','14042','24142',
                          '99830','19296','97233','32152','98174',
                          '95895','60494','35088','23603','73791',
                          '58825','88403','30234','75361','48500',
                          '23089','98196','41244','46089','45627',
                          '20736','42777','40740','55702','32210',
                          '35611','51603','37365','16038','59272',
                          '26687','73682','91079','41580','79757',
                          '40956','19482','13240','34258','77016',
                          '99153','44583','60691','27863','57006',
                          '53227','96950','28421','14222','64690',
                          '49375','80149','30313','62642','18790',
                          '29639','70730','65816','69579','36572',
                          '74544','11144','10028','58291','93361',
                          '97784','91959','97751','31557','70272',
                          '21376','10905','56242','87729','10640',
                          '86476','78662','44380','21699','90390',
                          '12224','51136','66254','24138','81065',
                          '52571','68524','54732','88357','42168',
                          '90776','92973','45502','57962','16926',
                          '27003','31543','72029','13351','32055',
                          '98232','48752','95783','77659','49485',
                          '86870','45019','90114','43678','64417',
                          '96170','37243','23879','84987','89958',
                          '17239','57547','20002','31086','23719',
                          '77602','45325','85457','82257','89930',
                          '34030','78823','28427','86655')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 8 in stream 0 using template query8