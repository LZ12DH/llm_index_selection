
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '56671','48291','44332','42611','94102','94204',
                          '67399','71046','82311','73315','31637',
                          '78070','41299','41666','10040','23904',
                          '93494','40076','20985','93184','80705',
                          '85472','97512','43580','72044','15330',
                          '55732','59256','91653','19984','71200',
                          '47408','19312','83348','73804','85042',
                          '77413','91131','61775','40118','23928',
                          '22888','99244','80608','52913','50908',
                          '17701','22330','16845','73413','49533',
                          '36605','92179','30806','64367','14696',
                          '81838','37983','55098','18897','16571',
                          '11385','14262','88966','79507','92629',
                          '17132','99965','35084','71891','43869',
                          '75887','62070','49954','91587','31677',
                          '44204','44911','68847','12440','43255',
                          '67185','57593','76910','11232','26451',
                          '23432','82208','41003','19259','32897',
                          '25655','16738','55210','71464','30232',
                          '66429','92722','36907','42459','53487',
                          '37550','20877','76181','50450','30614',
                          '55058','27442','23912','58560','19747',
                          '60566','88822','39638','32419','14918',
                          '35188','19627','63763','74864','98481',
                          '52675','55170','44485','17492','36663',
                          '33253','12516','22151','21829','18689',
                          '97476','59376','70660','66925','80657',
                          '70760','46776','51529','63498','60544',
                          '14970','47372','93045','42763','26669',
                          '87583','33265','99820','45503','71420',
                          '71271','48537','45197','72072','82510',
                          '77534','79011','50741','46337','57353',
                          '90524','18246','38492','34148','78655',
                          '17816','26172','81366','77655','75235',
                          '73959','55083','41215','40809','82274',
                          '32960','15784','87884','92121','80155',
                          '28326','83120','44181','90947','77312',
                          '77823','83157','25200','27344','59492',
                          '42273','92393','34751','10421','42050',
                          '26015','39228','56608','86387','56673',
                          '48496','12885','56918','98336','83126',
                          '83439','32827','98126','15178','77352',
                          '72537','74276','96531','88839','16015',
                          '99418','42910','32770','85066','34901',
                          '76185','71321','87966','88267','89100',
                          '55857','21209','25560','81282','86955',
                          '86769','87238','96427','36819','57516',
                          '24299','19134','51287','50082','43615',
                          '58403','87661','67238','71350','41463',
                          '27313','94454','34037','16321','15358',
                          '19972','51142','32703','81786','24538',
                          '35940','26524','12879','53983','67358',
                          '85593','89655','97149','28121','94792',
                          '13980','24008','68521','46254','25686',
                          '30338','31666','74896','17399','44561',
                          '88872','44084','98695','65239','90644',
                          '39372','49861','89212','54425','13357',
                          '88023','56479','58810','59591','46196',
                          '65872','71607','61243','43556','43432',
                          '27631','32834','26517','91014','34251',
                          '66450','61849','93277','87092','64118',
                          '16597','47811','97733','97975','36597',
                          '14054','72291','36374','49394','89707',
                          '71426','31468','81235','55683','33006',
                          '45191','28716','75453','11936','17941',
                          '48101','47385','42190','50520','96645',
                          '37460','68331','93624','52977','15147',
                          '69561','18522','89898','56419','65648',
                          '79870','39656','12537','98803','96211',
                          '15624','19008','66961','33721','21489',
                          '62095','58846','48141','70649','18314',
                          '36909','47572','38042','71679','11708',
                          '82289','70358','45629','73841','79581',
                          '41183','85973','71706','76621','19220',
                          '97770','96525','73729','45228','60571',
                          '82622','12466','65685','99026','82153',
                          '15830','59034','15271','11845','77691',
                          '86906','58661','94300','95295','45539',
                          '31133','63192','85641','36755','56452',
                          '51294','97876','17423','81413')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 8 in stream 0 using template query8