
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '92821','87717','62894','86092','50488','34484',
                          '92285','20988','74641','22829','15605',
                          '52707','69229','10501','50273','10981',
                          '28808','85294','72632','68587','69560',
                          '79098','71880','33343','22976','65412',
                          '12073','54794','40701','52126','67185',
                          '51879','12237','11421','29178','62032',
                          '96063','26265','64297','29085','65957',
                          '17750','49139','99962','82271','93080',
                          '86546','65963','52627','15514','38919',
                          '10317','82134','65038','29534','52114',
                          '79729','84815','75002','57872','49906',
                          '97491','36932','42519','48386','39907',
                          '32792','56899','49398','73050','47498',
                          '75323','19956','43180','29435','80540',
                          '32814','34667','24878','83872','40237',
                          '89146','71820','59705','21120','99247',
                          '68245','21521','26811','64932','84630',
                          '33201','15473','48841','53240','18656',
                          '73967','47049','68392','99634','96864',
                          '57322','17236','38438','99324','17011',
                          '24205','58724','45639','83778','88705',
                          '96336','75930','25599','72030','74425',
                          '50622','90409','62554','90827','66497',
                          '47411','59314','10136','49099','86843',
                          '37022','89305','35736','91853','18710',
                          '50439','43653','42836','59452','25555',
                          '46617','68010','79997','30656','15578',
                          '25980','93052','29591','83158','15093',
                          '63914','24686','28525','57457','99907',
                          '31654','38495','88439','51712','64339',
                          '93525','79552','18647','30738','65595',
                          '78488','38168','64265','99779','24853',
                          '37613','20135','75766','82265','85573',
                          '33707','24409','55656','63291','56514',
                          '91497','35135','33051','67070','66794',
                          '20934','49220','85729','57623','19461',
                          '10820','60796','94502','29754','78234',
                          '38347','59716','76209','12485','65352',
                          '35327','62460','13035','25522','65240',
                          '88759','25927','94715','80553','53703',
                          '31928','36522','34529','92143','69581',
                          '15573','59759','42349','47867','40481',
                          '73617','10340','51250','23348','10328',
                          '82365','12345','33501','18400','90053',
                          '81856','67853','99802','87132','43962',
                          '93507','89974','28980','65280','50109',
                          '13219','54234','47144','77982','70437',
                          '94672','79238','96555','38531','15639',
                          '53279','20881','71020','90720','59876',
                          '51752','17553','44976','93311','38327',
                          '10705','93569','79496','35886','90387',
                          '76961','88798','92859','91877','63000',
                          '21908','83531','91817','80995','20424',
                          '21113','80733','43837','57304','91767',
                          '51975','33023','31040','36380','62809',
                          '57974','18279','97037','56428','80827',
                          '45208','98550','17688','92068','94694',
                          '97691','81320','80242','76428','49305',
                          '63428','22238','30295','59101','40971',
                          '51592','17001','85122','70795','77516',
                          '36732','47923','84555','64630','58949',
                          '33408','71660','35534','26071','58100',
                          '12913','44655','10905','32041','13397',
                          '17799','66656','31980','63101','49658',
                          '76508','66119','89938','87014','11699',
                          '87543','70693','29884','50188','21259',
                          '19404','35915','29949','91840','66219',
                          '78951','33869','68393','38791','79556',
                          '91164','11321','82775','80095','36560',
                          '87051','31261','52441','10575','89207',
                          '16563','84634','55649','92464','41520',
                          '48505','68628','34575','96459','92717',
                          '78315','96250','85508','81782','27224',
                          '68765','70521','28314','39222','64194',
                          '63644','60622','18992','81051','35942',
                          '11805','77490','60580','67690','53440',
                          '87306','82663','94852','84683','99211',
                          '89147','27841','84305','53695','45187',
                          '69807','36811','13154','52562')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 8 in stream 0 using template query8