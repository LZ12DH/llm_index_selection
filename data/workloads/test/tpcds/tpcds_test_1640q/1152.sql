
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '61161','99222','52629','25480','16819','71512',
                          '21916','67741','35307','67617','15242',
                          '32652','16190','70125','49391','29706',
                          '73503','76905','19529','35836','74182',
                          '92718','19773','19272','28143','80193',
                          '85420','44826','63929','37855','92563',
                          '33057','19306','95830','22465','59202',
                          '89670','68605','15556','71229','12923',
                          '69789','13044','80772','92659','49518',
                          '52934','31636','21199','95712','73480',
                          '29797','30377','18166','20009','64598',
                          '47952','87032','93908','51022','33624',
                          '86920','81119','68871','96167','18849',
                          '87997','97710','26954','74765','66430',
                          '76001','28375','70336','25718','95127',
                          '47082','29855','45408','51066','27324',
                          '53420','43940','31761','38303','36132',
                          '20468','11969','88449','49290','70450',
                          '37957','33818','80515','14663','13704',
                          '17707','85079','33469','25587','15158',
                          '49223','81750','24619','84618','70833',
                          '98684','23031','38953','10645','85988',
                          '31579','60419','77891','33665','62368',
                          '30232','43823','39499','36283','25496',
                          '55486','23967','25426','44567','42109',
                          '61505','45123','56593','87533','91342',
                          '62690','35872','18887','56686','17060',
                          '69555','18346','52339','39196','28909',
                          '47874','71529','58532','39146','89858',
                          '81252','17257','14719','14237','99306',
                          '91804','68177','54970','32759','81865',
                          '89439','29094','93216','28439','32592',
                          '38308','86335','13943','49865','27895',
                          '26588','18673','53448','84658','27197',
                          '71481','31746','78138','29365','31908',
                          '45819','47346','52158','65906','35469',
                          '10992','90690','92116','84968','89917',
                          '81744','36985','67678','58369','40948',
                          '69920','17497','88984','58632','17692',
                          '15175','70799','54065','95726','34971',
                          '97891','99829','36167','13695','64006',
                          '43867','46354','34331','58937','44561',
                          '20362','95996','79339','48834','66312',
                          '10913','50949','10308','16929','98499',
                          '37573','25319','59165','66707','57140',
                          '48921','92419','87024','35422','78828',
                          '39403','22822','31727','61496','61612',
                          '83781','47307','20483','92786','10186',
                          '45312','97783','18418','35063','54055',
                          '64485','62438','36699','68561','46951',
                          '94253','77817','86488','17106','89700',
                          '81443','75473','92450','78299','92648',
                          '32845','95213','87405','32380','48932',
                          '18511','72980','79283','14528','21728',
                          '48460','84926','41424','22961','75718',
                          '88436','64075','68382','34500','89511',
                          '32678','43164','93566','92637','85852',
                          '38505','43351','62919','10714','60334',
                          '76610','16063','62794','88360','84913',
                          '82006','80556','22551','87844','19359',
                          '89687','41025','93253','19171','34678',
                          '20168','15470','89525','66807','99372',
                          '82634','57233','52795','75117','34589',
                          '92753','93790','19742','51747','61512',
                          '13104','70232','69256','26594','93314',
                          '39835','91641','26703','43255','90329',
                          '24622','31650','16310','67629','13517',
                          '72593','26381','73664','96772','71662',
                          '45043','44922','46408','42261','70902',
                          '87093','22631','14099','95973','29552',
                          '15852','62548','47232','45767','34094',
                          '44982','47240','98088','27510','64596',
                          '67292','74534','49610','22501','74479',
                          '46071','99975','86517','21831','55326',
                          '55320','63962','42870','28800','98741',
                          '51828','22326','79534','69805','76759',
                          '40303','78096','54002','33995','51286',
                          '92809','88827','76912','60580','61764',
                          '16171','55081','79422','97691','56068',
                          '30479','18446','80380','94872')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 8 in stream 0 using template query8