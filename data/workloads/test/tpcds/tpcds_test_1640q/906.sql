
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '85841','85854','39792','62301','87240','91126',
                          '80937','94453','83859','87908','71643',
                          '14817','42519','65805','26651','79370',
                          '41441','57764','71884','68956','29592',
                          '70602','90674','35590','60836','42745',
                          '35192','73194','41470','24975','25214',
                          '60976','74193','44709','44764','36518',
                          '86383','91491','40987','28963','65561',
                          '64666','88231','99141','89456','32998',
                          '42688','31897','93681','45924','57784',
                          '91624','49040','13575','84604','91440',
                          '13047','75012','40282','18646','80361',
                          '59376','65382','31947','59649','79387',
                          '32927','16435','80670','56935','99386',
                          '47540','23677','39088','27435','89541',
                          '18436','12921','47787','46354','51547',
                          '19773','64180','29100','38500','93104',
                          '70463','54089','86260','89861','79647',
                          '43872','73829','81773','90467','28093',
                          '18611','73168','89131','52406','64351',
                          '41030','25027','19757','27555','46769',
                          '66928','62524','35906','93066','52592',
                          '60072','98739','12221','84752','35842',
                          '37772','88279','44854','68604','26104',
                          '37442','97942','56191','36368','86670',
                          '63070','86824','41508','94072','47756',
                          '15029','92215','34763','12901','65215',
                          '38550','83640','11613','99589','46890',
                          '74546','66026','57468','37573','16312',
                          '12311','53403','11393','34834','94606',
                          '44079','41677','16603','55991','18209',
                          '52323','25111','21321','17778','52732',
                          '60099','79753','44427','41162','78301',
                          '21868','11109','81028','78522','90789',
                          '88425','71675','15401','27982','63605',
                          '93502','30963','79164','85281','11225',
                          '62738','51470','14150','77732','83529',
                          '24539','17174','63162','88853','77612',
                          '32272','67952','34462','51712','71648',
                          '99421','34720','87792','49553','73593',
                          '51504','57257','87156','50189','76070',
                          '61071','21248','33775','55814','37694',
                          '38241','36489','75451','73162','26831',
                          '15542','79442','73793','62940','57351',
                          '25076','14528','91294','43584','17729',
                          '30359','48444','71449','79855','57412',
                          '43919','20149','56181','61321','19065',
                          '55745','71733','26560','58978','82404',
                          '20082','50977','14159','21944','18717',
                          '97876','65892','21639','83350','15094',
                          '24770','71752','36665','36614','57675',
                          '92087','23598','30930','10710','19091',
                          '79018','51367','40937','10540','78331',
                          '79649','30772','23037','96545','58561',
                          '19603','11556','87656','28199','61383',
                          '23430','59857','48158','43721','30515',
                          '95715','81568','16613','45612','90844',
                          '91712','18655','96590','35041','25971',
                          '16334','55002','95454','77774','79504',
                          '56258','25809','26098','68792','45142',
                          '84736','58931','56006','13778','86249',
                          '28991','14465','20485','17240','30671',
                          '64973','54539','45521','97294','38731',
                          '96724','99656','45587','62580','90448',
                          '57611','70507','19647','26558','93042',
                          '97021','35299','59141','45159','30816',
                          '69826','89005','26193','68240','27621',
                          '52898','38219','69214','38643','82159',
                          '99646','67371','97359','69785','11510',
                          '96442','70761','41818','20650','73938',
                          '76405','91144','29023','19922','14861',
                          '69949','38248','93950','96747','75690',
                          '28756','82550','56358','56653','10232',
                          '82783','21119','52244','62290','58779',
                          '72172','11760','75537','85912','95980',
                          '55011','76337','62363','94704','65076',
                          '73332','19506','97874','20227','60826',
                          '52440','43740','46251','50943','44401',
                          '17155','92023','15730','84773','61661',
                          '41108','36680','31395','11259')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 8 in stream 0 using template query8