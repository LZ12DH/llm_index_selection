
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94024','56194','89233','54860','79107','60129',
                          '32709','76381','73515','66809','17623',
                          '79618','81532','90161','15807','88525',
                          '65106','12965','28318','59750','92150',
                          '30218','30960','46427','95426','64667',
                          '11002','15116','58526','24104','21330',
                          '41379','83396','11267','23932','53041',
                          '22170','64379','86455','59929','34095',
                          '74060','92254','81122','18351','40140',
                          '42283','55035','21005','28833','56888',
                          '76226','70311','43719','82855','98442',
                          '12061','47144','18065','81077','27892',
                          '83860','97147','49588','16311','55621',
                          '64918','73365','45174','29638','23694',
                          '75801','71548','38519','50035','33039',
                          '86586','35365','23645','70538','20671',
                          '29824','48530','52708','11118','96715',
                          '35508','30639','71699','81385','73132',
                          '19884','23376','15298','83496','10195',
                          '56966','38157','84608','21711','92522',
                          '79700','89018','66044','40756','26456',
                          '99388','19161','12781','31241','75483',
                          '34501','64589','83462','36856','55258',
                          '64668','86550','73324','15540','82197',
                          '14345','20130','17520','15731','23165',
                          '99707','21166','15598','78037','42702',
                          '84669','78858','59384','50121','51683',
                          '85440','33113','84462','81625','66461',
                          '98220','53117','28163','66667','78032',
                          '44576','43539','64948','30278','88100',
                          '74837','35441','71070','82989','23981',
                          '14295','39468','18530','45546','33364',
                          '54022','27584','46608','28277','31045',
                          '56521','35225','63616','67827','85422',
                          '57919','98159','21906','35955','30909',
                          '42288','65211','48757','58520','82638',
                          '50645','37228','98981','61526','54764',
                          '94391','20866','53775','81439','48852',
                          '67772','49001','95800','74435','27971',
                          '83114','44876','57347','80005','59987',
                          '35696','16943','50307','52352','59223',
                          '62028','39550','63735','83414','22298',
                          '20482','47844','21318','69866','44886',
                          '13086','72666','35081','58359','86756',
                          '78921','86461','36939','76977','93513',
                          '90218','58647','59102','26486','80887',
                          '87893','17001','87821','63654','23066',
                          '87223','89462','32120','57328','80285',
                          '89332','58780','52057','20445','81027',
                          '32230','94452','54949','39491','41447',
                          '46528','27440','74558','46737','56645',
                          '65871','19896','94900','49519','12860',
                          '33628','63278','32905','97744','80067',
                          '41521','58055','53253','97696','47713',
                          '81135','23640','43607','25497','89619',
                          '14404','99533','18797','49516','19638',
                          '59492','13253','46202','37429','38927',
                          '52378','66978','20446','33837','71847',
                          '59354','77581','66600','89582','68233',
                          '10537','99748','68760','15684','91218',
                          '54701','68326','91168','90049','32560',
                          '32107','64483','69651','72792','13436',
                          '70713','79852','48453','51141','84088',
                          '94627','62123','99210','66543','51371',
                          '99331','70235','53297','32947','21854',
                          '23453','48404','27042','51082','35125',
                          '27671','82256','20864','61508','21165',
                          '54842','36772','44132','82662','35069',
                          '66374','51837','21944','44975','28992',
                          '70845','55290','77738','38501','54364',
                          '95005','31282','30296','39737','20963',
                          '46510','26792','66007','35003','54256',
                          '23586','95953','88729','16774','45894',
                          '13472','29064','54086','80556','57257',
                          '31253','64489','43615','76588','48375',
                          '88466','28859','55241','16381','44495',
                          '45751','48461','37162','61680','37207',
                          '48013','89976','92248','71889','47137',
                          '15070','71355','29698','51362','74403',
                          '46453','78444','86267','91045')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 8 in stream 0 using template query8